# mini Claude Code v9：自治团队 -- Agent 系统的终极形态

v8 给了 Agent 团队通信的能力：消息邮箱、广播、关闭协议。但 v8 的 Teammate 本质上还是"被动同事"——给了任务就干，干完就退出。

v9 补上最后一环：**Teammate 自治**。它们不再等命令，而是自己找活干。

## 1. 自治的三个要素

v9 在 v8 的基础上新增三个核心机制：

```sh
空闲循环      Teammate 工作完成后不退出，进入 idle 状态
              每 2 秒检查邮箱和任务看板，持续 60 秒
              发现新消息或未认领任务就唤醒

任务自动认领  idle 时扫描看板，发现 pending + 无 owner + 无 blocker 的任务
              自动设为 in_progress，设置 owner = 自己
              先到先得，线程锁防竞态

身份保持      上下文压缩后，Teammate 可能"忘记"自己是谁
              循环中检测压缩，在压缩摘要后追加身份信息
              "Remember: You are teammate 'backend' in team 'rest-to-graphql'"
```

## 2. 完整的 Teammate 状态机

```sh
  +--------+      工作完成       +------+
  | active | ----------------> | idle |
  +--------+                   +------+
      ^                           |
      |     收到新消息/发现新任务    |
      +---------------------------+

  任何状态 -- shutdown_request --> [shutdown]
```

关键区别：
- **v8**: active -> 完成 -> 退出
- **v9**: active -> 完成 -> idle -> (发现新工作) -> active -> ...

## 3. 空闲循环代码

```python
# === Idle 阶段 ===
teammate.status = "idle"

for _ in range(30):  # 每 2 秒检查, 共 60 秒
    if teammate.status == "shutdown":
        return

    # 检查邮箱
    new_messages = self.check_inbox(teammate.name, teammate.team_name)
    if new_messages:
        if any(m.get("type") == "shutdown_request" for m in new_messages):
            return
        sub_messages.append({"role": "user", "content": format(new_messages)})
        break

    # 自动认领未分配任务
    unclaimed = [t for t in TASK_MGR.list_all()
                 if t.status == "pending" and not t.owner and not t.blocked_by]
    if unclaimed:
        TASK_MGR.update(unclaimed[0].id, status="in_progress", owner=teammate.name)
        sub_messages.append({
            "role": "user",
            "content": f"Unclaimed task found - #{unclaimed[0].id}: {unclaimed[0].subject}"
        })
        break

    time.sleep(2)
```

30 次循环 x 2 秒 = 60 秒的空闲窗口。在这个窗口内：
1. 有新消息 -> 注入上下文，回到 active
2. 有未认领任务 -> 认领，回到 active
3. 收到 shutdown -> 退出
4. 什么都没有 -> 继续下一轮 idle

## 4. 身份保持

上下文压缩会生成一个摘要替换所有旧消息。问题是：摘要里不包含"你是谁"。

```python
if CTX.should_compact(sub_messages):
    sub_messages = CTX.auto_compact(sub_messages)
    # 压缩后重新注入身份
    identity = f"\n\nRemember: You are teammate '{teammate.name}' in team '{teammate.team_name}'."
    if sub_messages and sub_messages[0].get("role") == "user":
        sub_messages[0]["content"] += identity
```

没有这个机制，压缩后的 Teammate 可能开始表现得像独立 Agent，忘记自己的团队角色。

## 5. 完整协作流程

```sh
用户: "把应用从 REST 迁移到 GraphQL"

Team Lead:
  1. TeamCreate("rest-to-graphql")
  2. TaskCreate("Analyze REST endpoints")              -> #1
     TaskCreate("Design GraphQL schema")               -> #2, blockedBy=#1
     TaskCreate("Implement resolvers")                  -> #3, blockedBy=#2
     TaskCreate("Update frontend queries")              -> #4, blockedBy=#3

  3. Task(name="analyst",  team_name=..., prompt="分析 REST 端点")
     Task(name="backend",  team_name=..., prompt="处理后端迁移")
     Task(name="frontend", team_name=..., prompt="处理前端更新")

执行过程:

  analyst:  看到 #1 -> 认领 -> 执行 -> 完成 -> idle
                                                   |
  backend:  空闲中... <--- #2 解锁 ---------------+
            认领 #2 -> 完成 -> 认领 #3 -> 完成 -> idle
                                                     |
  frontend: 空闲中... <--- #4 解锁 -----------------+
            认领 #4 -> 执行 -> 完成 -> idle

  Team Lead: 收到通知 -> 所有任务完成
             TeamDelete("rest-to-graphql")
```

注意 Team Lead **没有**手动分配任务给具体的 Teammate。它只创建了任务和 Teammate，剩下的由 Teammate 自组织完成。

## 6. 四个机制联动

| 机制 | 角色 | 比喻 |
|------|------|------|
| Tasks (v6) | 共享看板 | 办公室白板，所有人看同一个 |
| Background (v7) | 并行执行 | 每人一张桌子，同时干活 |
| Messages (v8) | 点对点通信 | 同事之间直接对话 |
| Autonomy (v9) | 自组织 | 没人分配，自己找活干 |

缺少任何一个，协作都不完整。

## 7. v0 到 v9 完整回顾

| 版本 | 核心主题 | 行数 | 关键洞察 |
|------|----------|------|----------|
| v0 | Bash is All | ~196 | 一个工具 + 递归 = 完整 Agent |
| v1 | Model as Agent | ~417 | 模型是 80%，代码是工具循环 |
| v2 | 结构化规划 | ~531 | Todo 让计划可见 |
| v3 | 分而治之 | ~623 | 子代理隔离上下文 |
| v4 | 领域专家 | ~783 | Skills 注入知识 |
| v5 | 永不遗忘 | ~896 | 三层压缩模拟记忆 |
| v6 | 团队看板 | ~957 | Tasks 替代 Todo |
| v7 | 并行执行 | ~1022 | 后台任务 + 通知 Bus |
| v8 | 团队通信 | ~1402 | Teammate 消息协议 |
| **v9** | **自治团队** | **~1506** | **空闲循环 + 自动认领** |

十个版本，从 16 行到约 1506 行 Python，覆盖了从单 Agent 到自组织多 Agent 团队的完整设计。

## 8. 更深的洞察

v0 到 v9 的演进讲了一个完整的故事：

```sh
v0: 一个 Agent, 一个工具
v1: 一个 Agent, 多个工具
v2: 一个 Agent, 有计划
v3: 一个 Agent, 能派人
v4: 一个 Agent, 有知识
v5: 一个 Agent, 能遗忘
v6: 多个 Agent, 有看板
v7: 多个 Agent, 能并行
v8: 多个 Agent, 能通信
v9: 多个 Agent, 能自治
```

每一步都在解决前一步暴露的瓶颈。v9 是终点——不是因为不能再加功能，而是因为 Agent 协作的基本元素已经齐全了：**共享状态 + 并行执行 + 双向通信 + 自治能力**。

更深层的洞察是：**Agent 系统的终极形态不是一个更聪明的模型，而是一群能协作和自组织的模型。** 人类文明的复杂性也不是来自单个大脑的进化，而是来自协作机制的进化：语言、文字、组织、制度。

---

**一个 Agent 能力有限，一群自治 Agent 无所不能。Agent 系统的进化不是让个体更强，而是让群体更协调。**

完整代码见仓库 `v9_autonomous_agent.py`。
