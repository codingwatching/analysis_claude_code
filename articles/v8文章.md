# mini Claude Code v8：Agent 团队通信 -- 从命令到协作

v3 引入了子代理，v7 引入了后台执行。它们解决了"做什么"和"怎么并行做"的问题。但还缺一个关键能力：**持久化的团队协作**。

子代理是一次性的——执行完就销毁，上下文消失。当任务是"前端和后端同时开发一个新功能"时，一次性子代理不够用：前端做完了，后端想问"API 接口定义是什么"，但前端已经"死了"。

v8 引入 Teammate 机制：持久的 Agent 同事，通过消息邮箱通信，共享任务看板。

## 1. 三种角色

```sh
Subagent (实习生):
  "去把这个文件分析一下, 回来告诉我结果"
  -> 干一件事, 回来汇报, 离开

Teammate (同事):
  "你负责后端开发, 有问题随时沟通"
  -> 在分配的任务上工作, 互相沟通

Team Lead (经理):
  "我来拆任务, 你们各自负责, 有进展告诉我"
  -> 创建团队, 分配工作, 协调
```

| 特性 | Subagent (v3) | Teammate (v8) |
|------|---------------|---------------|
| 生命周期 | 执行一次就销毁 | 持久运行 |
| 通信方式 | 返回值（单向） | 消息协议（双向, 5 种类型） |
| 并行方式 | 伪并行（主 Agent 等待） | 真并行（独立线程） |
| 任务管理 | 无 | 共享 Tasks 看板 (v6) |

## 2. 系统架构

```sh
+-------------------------------------------------------------------+
|                        Team Lead (主 Agent)                         |
|                                                                     |
|  工具: TeamCreate, SendMessage, TeamDelete, TaskCreate, TaskList    |
+-------------------------------------------------------------------+
      |                    |                    |
   [创建]              [消息]              [消息]
      |                    |                    |
+-------------+   +-------------+   +-------------+
| Teammate:   |   | Teammate:   |   | Teammate:   |
| "frontend"  |   | "backend"   |   | "analyst"   |
|             |   |             |   |             |
| - 独立线程   |   | - 独立线程   |   | - 独立线程   |
| - 独立上下文 |   | - 独立上下文 |   | - 独立上下文 |
| - 独立压缩   |   | - 独立压缩   |   | - 独立压缩   |
+------+------+   +------+------+   +------+------+
       |                 |                 |
       +-----------------+-----------------+
                         |
                  +------+------+
                  |   共享资源    |
                  |             |
                  | .tasks/    | <- 所有人看同一个看板
                  | .teams/    | <- 消息邮箱
                  +-------------+
```

## 3. 五种消息类型

```python
MESSAGE_TYPES = {
    "message",                  # 点对点消息
    "broadcast",                # 广播给所有人
    "shutdown_request",         # 请求关闭
    "shutdown_response",        # 确认关闭
    "plan_approval_response",   # Team Lead 审批计划
}
```

消息通过文件邮箱传递（`.teams/<team>/<name>_inbox.jsonl`），用文件而不是内存队列，原因和 Tasks 一样：跨线程安全，人类可调试。

## 4. Teammate 工作循环

v8 的 Teammate 循环是简化的：接收提示词，工作直到完成，检查邮箱，没有更多指令就退出。

```python
def _teammate_loop(self, teammate, initial_prompt):
    sub_system = f"You are teammate '{teammate.name}'..."
    sub_messages = [{"role": "user", "content": initial_prompt}]

    while teammate.status != "shutdown":
        teammate.status = "active"
        # 正常 Agent Loop: API 调用 + 工具执行
        response = client.messages.create(...)
        if response.stop_reason == "tool_use":
            # 执行工具，继续循环
            continue

        # 检查邮箱
        new_messages = self.check_inbox(teammate.name, teammate.team_name)
        if new_messages:
            if any(m.get("type") == "shutdown_request" for m in new_messages):
                return
            sub_messages.append({"role": "user", "content": format(new_messages)})
            continue

        return  # 没有更多工作
```

关键：v8 的 Teammate 不会自动认领任务，也没有空闲循环。它执行分配的工作，响应消息，工作完成就退出。这些高级行为在 v9 中引入。

## 5. 团队管理流程

```python
# 1. 创建团队
TeamCreate(name="rest-to-graphql")

# 2. 生成 Teammate
Task(name="backend", team_name="rest-to-graphql", prompt="处理后端迁移")
Task(name="frontend", team_name="rest-to-graphql", prompt="处理前端更新")

# 3. 与 Teammate 通信
SendMessage(recipient="backend", content="Database schema is ready")

# 4. 解散团队
TeamDelete(name="rest-to-graphql")
```

同一个 `Task` 工具，三种模式：
- 无额外参数：同步子代理 (v3)
- `run_in_background=True`：后台子代理 (v7)
- `team_name + name`：持久 Teammate (v8)

## 6. 工具权限分层

Teammate 获得的工具是 Team Lead 的子集：

```python
TEAMMATE_TOOLS = BASE_TOOLS + [TASK_CREATE_TOOL, TASK_UPDATE_TOOL, TASK_LIST_TOOL, SEND_MESSAGE_TOOL]
```

Teammate 能做什么：读写文件、执行命令、创建/更新任务、发送消息。
Teammate 不能做什么：生成其他 Agent、加载 Skill、管理团队本身。

这个设计确保 Team Lead 是唯一的编排者。

## 7. 洞察

v8 建立了团队通信的基础设施：
- **团队生命周期**：创建、成员管理、解散
- **消息邮箱**：JSONL 文件，读取即清空
- **工具分层**：Lead 有全部工具，Teammate 有工作子集

但 v8 的 Teammate 仍然是"被动同事"——被分配工作，执行，完成。它们不会自己去找活干。

下一步 v9 将赋予 Teammate 自治能力：空闲循环、自动认领任务、压缩后身份保持。

---

**从一个人下命令，到一群人互相协作。v8 建立了沟通的桥梁。**

完整代码见仓库 `v8_team_agent.py`。
